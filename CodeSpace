cd ~/hotel-management-backend

# Fix the views.py with correct imports
cat > apps/inventory/views.py << 'EOF'
# apps/inventory/views.py - FIXED VERSION
from rest_framework import viewsets, status
from rest_framework.decorators import action
from rest_framework.response import Response
from rest_framework.permissions import IsAuthenticated
from django.db.models import Q, Sum, Count, F  # ✅ FIXED: Added F import
from django.utils import timezone
from datetime import datetime, timedelta

from .models import (
    InventoryCategory, InventoryItem, Supplier, 
    PurchaseOrder, PurchaseOrderItem, StockMovement, LowStockAlert
)
from .serializers import (
    InventoryCategorySerializer, InventoryItemSerializer, SupplierSerializer,
    PurchaseOrderSerializer, StockMovementSerializer, LowStockAlertSerializer
)
from .permissions import IsAdminOnly

class InventoryCategoryViewSet(viewsets.ModelViewSet):
    queryset = InventoryCategory.objects.all()
    serializer_class = InventoryCategorySerializer
    permission_classes = [IsAuthenticated, IsAdminOnly]
    
    def get_queryset(self):
        queryset = InventoryCategory.objects.all()
        search = self.request.query_params.get('search', None)
        if search:
            queryset = queryset.filter(name__icontains=search)
        return queryset.order_by('name')

class InventoryItemViewSet(viewsets.ModelViewSet):
    queryset = InventoryItem.objects.all()
    serializer_class = InventoryItemSerializer
    permission_classes = [IsAuthenticated, IsAdminOnly]
    
    def get_queryset(self):
        queryset = InventoryItem.objects.select_related('category').all()
        
        # Search functionality
        search = self.request.query_params.get('search', None)
        if search:
            queryset = queryset.filter(
                Q(name__icontains=search) | 
                Q(sku__icontains=search) |
                Q(description__icontains=search)
            )
        
        # Category filter
        category = self.request.query_params.get('category', None)
        if category:
            queryset = queryset.filter(category_id=category)
        
        # Stock status filter - ✅ FIXED: Using F instead of models.F
        stock_status = self.request.query_params.get('stock_status', None)
        if stock_status == 'low':
            queryset = queryset.filter(current_stock__lte=F('min_stock_level'))
        elif stock_status == 'out':
            queryset = queryset.filter(current_stock=0)
        elif stock_status == 'over':
            queryset = queryset.filter(current_stock__gte=F('max_stock_level'))
        
        return queryset.order_by('name')
    
    @action(detail=False, methods=['get'])
    def low_stock(self, request):
        """Get items with low stock"""
        items = self.queryset.filter(
            current_stock__lte=F('min_stock_level'),  # ✅ FIXED: Using F
            is_active=True
        )
        serializer = self.get_serializer(items, many=True)
        return Response(serializer.data)
    
    @action(detail=False, methods=['get'])
    def stats(self, request):
        """Get inventory statistics"""
        try:
            total_items = self.queryset.filter(is_active=True).count()
            total_categories = InventoryCategory.objects.filter(is_active=True).count()
            
            # ✅ FIXED: Using F instead of models.F
            low_stock = self.queryset.filter(
                current_stock__lte=F('min_stock_level'),
                current_stock__gt=0,
                is_active=True
            ).count()
            
            out_of_stock = self.queryset.filter(current_stock=0, is_active=True).count()
            
            # ✅ FIXED: Using F instead of models.F
            total_value = self.queryset.filter(is_active=True).aggregate(
                total=Sum(F('current_stock') * F('cost_per_unit'))
            )['total'] or 0
            
            return Response({
                'total_items': total_items,
                'total_categories': total_categories,
                'low_stock_count': low_stock,
                'out_of_stock_count': out_of_stock,
                'total_inventory_value': float(total_value)
            })
        except Exception as e:
            return Response({
                'total_items': 0,
                'total_categories': 0,
                'low_stock_count': 0,
                'out_of_stock_count': 0,
                'total_inventory_value': 0,
                'error': str(e)
            }, status=status.HTTP_500_INTERNAL_SERVER_ERROR)
    
    @action(detail=False, methods=['get'])
    def dashboard_summary(self, request):
        """Dashboard summary - alias for stats"""
        return self.stats(request)

class SupplierViewSet(viewsets.ModelViewSet):
    queryset = Supplier.objects.all()
    serializer_class = SupplierSerializer
    permission_classes = [IsAuthenticated, IsAdminOnly]
    
    def get_queryset(self):
        queryset = Supplier.objects.all()
        search = self.request.query_params.get('search', None)
        if search:
            queryset = queryset.filter(
                Q(name__icontains=search) |
                Q(contact_person__icontains=search) |
                Q(phone__icontains=search) |
                Q(email__icontains=search)
            )
        return queryset.order_by('name')

class PurchaseOrderViewSet(viewsets.ModelViewSet):
    queryset = PurchaseOrder.objects.all()
    serializer_class = PurchaseOrderSerializer
    permission_classes = [IsAuthenticated, IsAdminOnly]
    
    def get_queryset(self):
        queryset = PurchaseOrder.objects.select_related('supplier').all()
        
        status_filter = self.request.query_params.get('status', None)
        if status_filter:
            queryset = queryset.filter(status=status_filter)
        
        supplier = self.request.query_params.get('supplier', None)
        if supplier:
            queryset = queryset.filter(supplier_id=supplier)
        
        return queryset.order_by('-created_at')
    
    def perform_create(self, serializer):
        serializer.save(created_by=self.request.user)

class StockMovementViewSet(viewsets.ModelViewSet):
    queryset = StockMovement.objects.all()
    serializer_class = StockMovementSerializer
    permission_classes = [IsAuthenticated, IsAdminOnly]
    
    def get_queryset(self):
        queryset = StockMovement.objects.select_related('item').all()
        
        item = self.request.query_params.get('item', None)
        if item:
            queryset = queryset.filter(item_id=item)
        
        movement_type = self.request.query_params.get('type', None)
        if movement_type:
            queryset = queryset.filter(movement_type=movement_type)
        
        # Date range filter
        date_from = self.request.query_params.get('date_from', None)
        date_to = self.request.query_params.get('date_to', None)
        
        if date_from:
            queryset = queryset.filter(date__gte=date_from)
        if date_to:
            queryset = queryset.filter(date__lte=date_to)
        
        return queryset.order_by('-created_at')
    
    def perform_create(self, serializer):
        serializer.save(recorded_by=self.request.user)

class LowStockAlertViewSet(viewsets.ModelViewSet):
    queryset = LowStockAlert.objects.all()
    serializer_class = LowStockAlertSerializer
    permission_classes = [IsAuthenticated, IsAdminOnly]
    
    def get_queryset(self):
        queryset = LowStockAlert.objects.select_related('item').all()
        
        resolved = self.request.query_params.get('resolved', None)
        if resolved is not None:
            is_resolved = resolved.lower() == 'true'
            queryset = queryset.filter(is_resolved=is_resolved)
        
        return queryset.order_by('-alert_date')
    
    @action(detail=True, methods=['post'])
    def resolve(self, request, pk=None):
        """Resolve a low stock alert"""
        alert = self.get_object()
        alert.resolve_alert(user=request.user, notes=request.data.get('notes', ''))
        return Response({'status': 'resolved'})
EOF

# Restart gunicorn immediately
sudo systemctl restart gunicorn

echo "✅ Fixed views.py and restarted gunicorn"
